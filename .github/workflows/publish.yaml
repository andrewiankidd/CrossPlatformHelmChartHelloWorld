name: Publish Hello World Images and Chart

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_REPOSITORY: ghcr.io/${{ github.repository_owner }}/crossplatform-helm-chart-hello-world
  IMAGE_TAG: latest

jobs:
  # Build and publish the Linux container image.
  build-linux-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the container registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build the Linux image
        run: |
          docker build -t ${IMAGE_REPOSITORY}-linux:${IMAGE_TAG} ./images/linux

      - name: Push the Linux image
        run: |
          docker push ${IMAGE_REPOSITORY}-linux:${IMAGE_TAG}

  # Build and publish the Windows container image (requires a Windows runner).
  build-windows-image:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the container registry
        shell: pwsh
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build the Windows image
        shell: pwsh
        run: |
          docker build -t ${env:IMAGE_REPOSITORY}-windows:${env:IMAGE_TAG} ./images/windows

      - name: Push the Windows image
        shell: pwsh
        run: |
          docker push ${env:IMAGE_REPOSITORY}-windows:${env:IMAGE_TAG}

  # Package and push the Helm chart after both images are available.
  publish-chart:
    runs-on: ubuntu-latest
    needs:
      - build-linux-image
      - build-windows-image
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Determine chart version
        run: |
          echo "CHART_VERSION=$(helm show chart chart | awk '/^version:/ {print $2}')" >> $GITHUB_ENV

      - name: Log in to the helm registry (OCI)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Package the chart
        run: |
          mkdir -p dist
          helm lint chart
          helm package chart --destination dist

      - name: Push the chart to GHCR
        run: |
          helm push dist/cross-platform-hello-${{ env.CHART_VERSION }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
